画板程序 ― 学校作业（北京邮电大学 QSQ ）

一、实验目的
---
本实验的主要目的是通过完成一个小型的图形编辑程序，来熟悉并实践：
- 使用 C语言 与 EGE 图形库进行简单的图形编程；
- 模块化设计思路（将界面、绘图、撤回/重做、保存/加载等功能拆分成不同源文件）；
- 文件输入输出（包括图片保存/加载与自定义二进制数据保存/加载）；
- 调试程序、处理输入异常与资源管理（内存、PIMAGE 等）。

二、实验内容（功能概述）
---
本程序实现了一个简易画板，主要功能包括：
- 自由绘图：用鼠标左键拖动绘制自由线条，支持颜色选择。
- 图形绘制：支持多边形（边数 3-9）与圆的交互式绘制，支持填充或仅绘轮廓。
- 撤回/重做：支持最多 10 级撤回（右键）和重做（中键），基于画布快照实现。
- 图片保存/加载：将画布保存为 PNG 文件，支持另存为与加载图片继续编辑。
- 图形数据保存/加载：把程序内部记录的图形元数据（`graph` 数组）保存为二进制 `.shp` 文件，后续可加载并直接将矢量图形重绘到画布。
- 查询显示：可查询已记录的图形并在临时画布上以可读格式显示结果（短时间后恢复原画布）。
- 简易菜单与按钮：提供菜单式交互与颜色、功能按钮（通过弹窗或鼠标点击触发）。

三、实验环境
---
- 操作系统：Windows。
- 开发工具：Visual Studio 2022。
- 图形库：EGE（Easy Graphics Engine）图形库，需事先配置并能与工程链接。
- 编程语言：C语言。

四、使用说明（编译与运行）
---
1. 准备环境：在 Visual Studio 中打开工程，确保 EGE 库路径和链接设置正确。
2. 编译工程：在 IDE 中构建解决方案（Build）。
3. 运行程序：运行可执行文件，程序启动时会询问是否加载已有画布（可选择加载或不加载）。

程序内常用操作：
- 左键按住拖动：在画布上绘制自由曲线；
- 右键：撤回（Undo）；
- 中键：重做（Redo）；
- 菜单选项：
  - "作画"：进入主绘图界面；
  - "保存画布" / "另存为"：保存为 PNG；
  - "加载画布"：从 PNG/BMP 加载图像文件到画布；
  - "保存图形数据"：把记录的图形元数据保存为 `.shp`；
  - "加载图形数据"：从 `.shp` 加载并重绘图形；
  - "查询图形"：以可读方式列出并显示部分 `graph` 内容。

五、实现说明（模块与关键点）
---
程序采用模块化设计，每个功能放在单独源文件中，便于开发与调试：
- `draw.*`：主绘图循环，处理鼠标事件、界面按钮、调用撤回/重做等。
- `graphic function.*`：多边形与圆的交互绘制逻辑，并把图形元数据写入 `graph` 数组。
- `undo.*`：使用 `PIMAGE` 快照实现撤回/重做栈（固定深度）。
- `save.*`：包含保存/加载 PNG 的函数，以及 `.shp` 二进制图形数据的读写函数。
- `query.*`：实现对 `graph` 的查询并临时显示结果。
- `ui.*`：辅助 UI 函数，例如 `showTempMessage()` 用于临时提示且恢复原画布区域，避免提示残留。

六、文件格式说明（图形数据 .shp）
---
当前项目将 `graph`（内存中的图形记录数组）以二进制方式写入 `.shp` 文件。实现要点：
- 为了简化实现，使用了结构体的二进制直接写入；因此文件与具体编译器的结构体对齐方式有关，跨平台兼容性有限。
- 保存时只写入有效项（`graphCount`），加载时按项读取直到文件结束或达到 `MAX_GRAPH` 上限。
- 若需要增强兼容性与可读性，建议改为文本格式（JSON/CSV）或在文件头写入签名/版本/项数信息。

七、测试与结果
---
我主要做了手动测试，包含以下场景：
- 绘制若干图形（多边形与圆），保存为 `.shp`，清屏后重新加载 `.shp`，图形能正确重绘在画布上。
- 保存为 PNG，并能在文件系统中查看 PNG，加载 PNG 后画布显示正确。
- 重复进行撤回与重做操作，栈深限制（10）内功能正常。
- 输入非法数据（例如文字当作数字、半径为负），程序会放弃当前操作并返回，不会崩溃。

八、已知问题与改进方向
---
- 当前绘图界面较为简单，交互多数依赖弹窗输入，用户体验可以进一步改进（例如在画布上直接点选顶点、拖拽调整）。

九、调试心得
---
- 编写小型模块并频繁测试：每次修改一个模块（例如只改 save/load），编译并运行，能快速定位错误。
- 注意资源释放：EGE 中 `newimage` 必须配对 `delimage`，临时 `malloc` 也要 `free`，否则长期运行会出现资源耗尽或内存泄漏。
- 输入要做校验：用户输入的字符串要按字符检查后再用 `atoi/sscanf` 转换，避免解析出错影响后续逻辑。
- 提示：临时提示最好是非破坏性的（记录被覆盖区域并恢复），避免遮挡画布内容。

十、流程图（程序核心流程与关键模块）
---
本工程包含四张主要流程图，用于帮助理解程序整体结构与重点逻辑：
- `overall.mmd` ― 程序整体流程
- `undo_redo.mmd` ― 撤回/重做流程（更详细，含栈操作与资源管理）
- `polygon.mmd` ― 多边形绘制流程
- `persistence.mmd` ― 图形数据持久化（保存/加载 `.shp`）

项目资源文件中包含了四张流程图的代码，可复制通过支持对应语法的编辑器转化为可视化图片进行查看（本人使用的Mermaid Live Editor)